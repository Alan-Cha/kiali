apiVersion: v1
kind: Template
metadata:
  name: sws
  labels:
    app: sws
parameters:
- description: The name of the image to use
  name: IMAGE_NAME
  value: jmazzitelli/sws
- description: The version of the image to use
  name: IMAGE_VERSION
  value: dev
- description: The namespace to use
  name: NAMESPACE
  value: istio-system
- description: Dictates the level of logs to emit. 3=INFO, 4=DEBUG, 5=TRACE
  name: VERBOSE_MODE
  value: "5"
objects:
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: sws
    labels:
      app: sws
- apiVersion: v1
  kind: Service
  metadata:
    name: sws
    labels:
      app: sws
  spec:
    ports:
      - name: tcp
        protocol: TCP
        port: 20001
    selector:
      app: sws
- apiVersion: v1
  kind: Route
  metadata:
    name: sws
    labels:
      app: sws
  spec:
    to:
      kind: Service
      name: sws
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    name: sws
    labels:
      app: sws
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: sws
    template:
      metadata:
        name: sws
        labels:
          app: sws
      strategy:
        rollingUpdate:
          maxSurge: 1
          maxAvailable: 1
        type: RollingUpdate
      spec:
        serviceAccount: sws
        containers:
        - image: ${IMAGE_NAME}:${IMAGE_VERSION}
          name: sws
          command:
            - "/opt/sws/sws"
            - "-config"
            - "/sws-configuration/config.yaml"
            - "-v"
            - "${VERBOSE_MODE}"
          env:
          - name: ACTIVE_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          volumeMounts:
          - name: sws-configuration
            mountPath: "/sws-configuration"
        volumes:
        - name: sws-configuration
          configMap:
            name: sws
- apiVersion: v1
  kind: ClusterRole
  metadata:
    name: sws
    labels:
      app: sws
  rules:
  - apiGroups: [""]
    attributeRestrictions: null
    resources:
    - configmaps
    - namespaces
    - nodes
    - pods
    - projects
    - services
    - endpoints
    verbs:
    - get
    - list
    - watch
  - apiGroups: ["config.istio.io"]
    attributeRestrictions: null
    resources:
    - routerules
    verbs:
    - get
    - list
    - watch
- apiVersion: v1
  kind: ClusterRoleBinding
  metadata:
    name: sws
    labels:
      app: sws
  roleRef:
    name: sws
  subjects:
  - kind: ServiceAccount
    name: sws
    namespace: ${NAMESPACE}
